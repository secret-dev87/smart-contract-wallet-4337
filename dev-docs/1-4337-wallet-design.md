
## 基于Argent模式+EIP4337协议实现合约钱包MVP
+ 本文从应用模块角度来分析钱包，落地场景，从而确定一个可演进的业务架构。
+ 进而完成场景的拆分、细化和行为定义，为系统整体给出定义和约束。
+ 实质上完成三部分工作：概念、逻辑和部分物理设计工作内容。

### 1.MVP功能范围，对外部用户而言
+ 任何人可以免费下载Chrome插件，使用自己的合约钱包地址（无需事先建立，自动创建）接受资产。
+ 任何人都可以从github查看本钱包的所有源代码，以确保可以check安全性，也可以自己从源代码build自己的插件。
+ 可以选择不同网络（主网、Arbi、OP），从而链接不同的EntryPoint，但是钱包地址可以保持不变？
+ 可以使用钱包的基本功能：
+ Get：收取来自任何EOA 钱包或者Contract wallet合约钱包发送的ERC20或者ERC721、ERC1155等Token资产。
+ Send：Transfer自己用于的上述资产到任何EOA或者Contract wallet Account地址。
+ Gas：Transfer目前需要自己预先存储一定的ETH支付自己合约钱包交易的gasfee，未来引入paymaster。
+ Dapp：正常连接和使用Layer2的DApp，DApp需要引用4337提供的SDK，从而适配4337钱包的签名登录和交易发起。
+ Recovery：选择Guardian（默认4337wallet官方团队是第一个），任何时间主动选择Recovery（通过link发送给Guardian）
+ Programming：目前仅提供日限额模块加载到contract wallet，后续扩展此功能。
+ 其他常规Wallet的功能，例如交易的查看（链接到scan url），不再赘述。
### 2.MVP的使用形式、网络和基本要求
+ Chrome、Safari、Edge等Webkit/Blink内核的常规版本，支持Chrome插件机制，未来会提供Brave、FF等的插件（本质相同）。
+ 目前只有插件方式，未来再考虑Page模式、移动端、PC端。
+ Relay如果有，需要在国内外都架设，提供基础的交易底层通信支持。
+ 基本沿袭Metamask的使用习惯（需要分析下，有哪些路径依赖习惯）。

### 3.MVP的场景和功能点拆解
+ 根据以上场景描述，我们来定义下MVP V0.1包含哪些场景Case，场景的流程会是如何发生，有哪些原子Action。
#### 获取
+ 访问 ***网址，提供各个商店链接，或者自行下载安装，获取对应浏览器的插件，安装后完成获取。
+ 需要产品设计细节
#### 初始化
+ 3秒钟初始化，立刻拥有自己的合约钱包地址，用来收款等操作。
+ 提示增强安全性：设置Guardiand等流程
+ 需要产品设计细节
#### Get
+ 复制地址，发送给别人，让别人打钱
+ 其他人交易成功后，钱包提示收款，点击提示查看交易细节。不同ERC，未来要给展示空间！尤其是NFT、SBT！
+ 需要产品设计细节
#### Send
+ 复制别人地址，在钱包界面发送
+ 传统钱包无大差异，提交，发送，确认界面，多了覆盖？取消？前步交易的选择（上链之前）
+ 需要产品设计细节
#### Gas
+ 所有涉及Gas支付的场景，多了一个check选项：预存gas到Entrypoint，支付gas有两个：使用Entrypoint还是当前钱包内token（eth，erc20，nft？）
+ 传统钱包无大差异
+ 需要产品设计细节
### 4.业务架构（核心场景抽象+未来预判）
+ 本文提取的是不变的内容：客户诉求、解决问题的场景、场景的交互动作、交互Action细节描述，无论4337还是其他协议，都会基于本业务架构来提供上层的业务场景服务。
+ 贯穿所有场景的是Account（Address，balance，setting（例如默认使用Entrypoint支付gas，是否开启日限额？））、Token（被操作的资产）、Gas（Tx中需要支付的gasfee）
+ DApp交互过程
+ 未来EVM以OpCode方式直接升级支持contract wallet，则init deploy、verify，approve、transfer、accept等核心业务场景动作不变，但原来Entrypoint实现的contract address被直接的合约代码替代，改造方式不会太复杂。
+ 这部分和产品要沟通一致，提炼出核心业务对象、业务行为、具体Action、核心出入参数，以及对未来业务场景（roadmap的预判和架构迁移的应对）。
### 5.主要场景的Action和API接口定义（伪代码）
+ 需要拆解用例图后画出来Action的时序图
+ 每次时序图交互，或者是API，或者是链上
+ 本部分和cejay的技术实现衔接
+ 会有一些列的图组成，先纸上，再提交draw.io
### 6.合约部分：基于4337标准的钱包，只增加一项：每日转账限额，需要自定义
+ 合约部分单独文档分析
+ 基于以下判断：
+ 1.4337钱包合约来源于4337的协议实现（有一个简单demo，但要我们扩展完整为一个基础功能具备的钱包合约）
+ 2.4337钱包合约需要我们部署，gasfee要思考清楚支付路径：垫付？预付？
+ 3.4337钱包合约的所有对外public是来源于时序图的交互行为的拆解，需要定义清楚出入参数和其他API约定。
+ 4.4337钱包合约的useroperation需要和测试网络的Entrypoint对齐，并能够跑通完成的基础业务Action.
+ 5.4337钱包合约需要思考清楚Bundler如何体现？还是我们只提交给EP，不考虑？
